name: Quick Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.kt'
      - '**.kts'
      - 'gradle/**'
      - 'gradle.properties'
      # Exclude platform-specific paths (handled by platform-validation.yml)
      - '!shared/src/linuxMain/**'
      - '!shared/src/mingwMain/**'
      - '!shared/src/androidNative*Main/**'
      # Exclude documentation
      - '!**.md'

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  quick-validation:
    name: Quick PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Quick Quality Check
        run: |
          echo "ðŸš€ Running quick PR validation..."

          echo "ðŸ“¦ Compiling JVM and common code..."
          ./gradlew compileKotlinJvm compileCommonMainKotlinMetadata

          echo "âœ… Running JVM tests (fastest)..."
          ./gradlew jvmTest

          echo "ðŸ” Running static analysis..."
          ./gradlew detekt

          echo "âœ… Quick check complete!"
          echo ""
          echo "â„¹ï¸ Full CI with all platforms and security scanning runs on merge to main"

  # Optional: Run full dependency check only on security-related changes
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      contains(github.event.head_commit.message, 'security') ||
      contains(github.event.head_commit.message, 'dependency') ||
      contains(github.event.head_commit.message, 'vulnerability')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Configure NVD API Key
        run: |
          if [ -n "${{ secrets.NVD_API_KEY }}" ]; then
            echo "nvd.api.key=${{ secrets.NVD_API_KEY }}" >> local.properties
            echo "âœ… NVD API key configured"
          fi

      - name: Run Security Scan
        run: |
          echo "ðŸ”’ Running dependency security scan..."
          ./gradlew dependencyCheckAnalyze --no-daemon